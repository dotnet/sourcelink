<?xml version="1.0" encoding="utf-8"?>
<Project>
  <PropertyGroup>
    <MSBuildAllProjects>$(MSBuildAllProjects);$(MSBuildThisFileFullPath)</MSBuildAllProjects>
  </PropertyGroup>

  <PropertyGroup>
    <_SourceLinkVstsGitAssemblyFile Condition="'$(MSBuildRuntimeType)' != 'Core'">$(MSBuildThisFileDirectory)..\tools\net461\Microsoft.SourceLink.Vsts.Git.dll</_SourceLinkVstsGitAssemblyFile>
    <_SourceLinkVstsGitAssemblyFile Condition="'$(MSBuildRuntimeType)' == 'Core'">$(MSBuildThisFileDirectory)..\tools\netcoreapp2.0\Microsoft.SourceLink.Vsts.Git.dll</_SourceLinkVstsGitAssemblyFile>
  </PropertyGroup>

  <UsingTask TaskName="Microsoft.SourceLink.Vsts.Git.GetSourceLinkUrl" AssemblyFile="$(_SourceLinkVstsGitAssemblyFile)"/>

  <PropertyGroup>
    <SourceLinkUrlInitializerTargets>$(SourceLinkUrlInitializerTargets);_InitializeVstsGitSourceLinkUrl</SourceLinkUrlInitializerTargets>
  </PropertyGroup>

  <Target Name="_InitializeVstsGitSourceLinkUrl" Inputs="@(SourceRoot)" Outputs="|%(Identity)|">
    <!--
      The task calculates SourceLink URL for a given SourceRoot.

      If the SourceRoot is associated with a git repository with a recognized domain the <see cref="SourceLinkUrl"/>
      output property is set to the content URL corresponding to the domain, otherwise it is set to string "N/A".

      Recognized domains are specified via Hosts (initialized from SourceLinkVstsGitHost item group) and ImplicitHost parameters.
      ImplicitHost is set based on PrivateRepositoryUrl by Microsoft.SourceLink.Common.targets if this package is the only SourceLink package in the project.

      Example of SourceLinkVstsGitHost items:

      <ItemGroup>
        <SourceLinkVstsGitHost Include="mytfs1.com" ContentUrl="http://mytfs1.com"/>
        <SourceLinkVstsGitHost Include="mytfs2.com" />           ContentUrl defaults to https://mytfs2.com
        <SourceLinkVstsGitHost Include="mytfs3.com:8080" />      ContentUrl defaults to https://mytfs3.com:8080
      </ItemGroup>

      ContentUrl is optional. If not specified it defaults to "https://{domain}".
    -->
    <Microsoft.SourceLink.Vsts.Git.GetSourceLinkUrl SourceRoot="@(SourceRoot)" Hosts="@(SourceLinkVstsGitHost)" ImplicitHost="$(SourceLinkImplicitRepositoryHost)">
      <Output TaskParameter="SourceLinkUrl" PropertyName="_SourceLinkUrlToUpdate"/>
    </Microsoft.SourceLink.Vsts.Git.GetSourceLinkUrl>

    <ItemGroup>
      <!-- Only update the SourceLinkUrl metadata if the SourceRoot belongs to this source control -->
      <SourceRoot Update="%(Identity)" SourceLinkUrl="$(_SourceLinkUrlToUpdate)" Condition="'$(_SourceLinkUrlToUpdate)' != 'N/A'"/>
    </ItemGroup>
  </Target>

</Project>
